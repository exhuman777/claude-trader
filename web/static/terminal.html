<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Trader - Web Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        :root {
            --bg: #0d1117;
            --bg-secondary: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --accent: #58a6ff;
            --green: #3fb950;
            --red: #f85149;
            --yellow: #d29922;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .status-bar {
            display: flex;
            gap: 1.5rem;
            font-size: 0.85rem;
            color: var(--text);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .status-dot.disconnected { background: var(--red); }

        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .terminal-container {
            flex: 1;
            padding: 0.5rem;
        }

        #terminal {
            height: 100%;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            border-bottom: 1px solid var(--border);
            padding: 1rem;
        }

        .sidebar-section h3 {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text);
            margin-bottom: 0.75rem;
            opacity: 0.7;
        }

        .api-list {
            font-size: 0.85rem;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .api-item {
            padding: 0.4rem 0;
            cursor: pointer;
            color: var(--accent);
        }

        .api-item:hover {
            text-decoration: underline;
        }

        footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        #input-field {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem 0.75rem;
            color: var(--text);
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 0.9rem;
        }

        #input-field:focus {
            outline: none;
            border-color: var(--accent);
        }

        .voice-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem 1rem;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .voice-btn:hover {
            border-color: var(--accent);
        }

        .voice-btn.recording {
            background: var(--red);
            border-color: var(--red);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .voice-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Quick commands */
        .quick-cmds {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .quick-cmd {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--text);
        }

        .quick-cmd:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Transcript display */
        #voice-transcript {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.85rem;
            color: var(--yellow);
            display: none;
        }

        #voice-transcript.active {
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <h1>Claude Trader</h1>
        <div class="status-bar">
            <div class="status-item">
                <span class="status-dot" id="ws-status"></span>
                <span id="ws-status-text">Connecting...</span>
            </div>
            <div class="status-item" id="positions-count">Positions: -</div>
            <div class="status-item" id="usdc-balance">USDC: -</div>
        </div>
    </header>

    <main>
        <div class="terminal-container">
            <div id="terminal"></div>
        </div>

        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>Quick Commands</h3>
                <div class="quick-cmds">
                    <button class="quick-cmd" data-cmd="orders">Orders</button>
                    <button class="quick-cmd" data-cmd="positions">Positions</button>
                    <button class="quick-cmd" data-cmd="status">Status</button>
                    <button class="quick-cmd" data-cmd="cancel all">Cancel All</button>
                    <button class="quick-cmd" data-cmd="memory">Memory</button>
                    <button class="quick-cmd" data-cmd="insights">Insights</button>
                    <button class="quick-cmd" data-cmd="help">Help</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>API Endpoints</h3>
                <div class="api-list">
                    <div class="api-item" data-cmd="show_event('')">show_event(slug)</div>
                    <div class="api-item" data-cmd="place_order()">place_order()</div>
                    <div class="api-item" data-cmd="place_ladder()">place_ladder()</div>
                    <div class="api-item" data-cmd="quick_buy()">quick_buy()</div>
                    <div class="api-item" data-cmd="quick_sell()">quick_sell()</div>
                    <div class="api-item" data-cmd="orders">show_orders()</div>
                    <div class="api-item" data-cmd="cancel all">cancel_all()</div>
                    <div class="api-item" data-cmd="positions">get_positions()</div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Voice (Polski/English)</h3>
                <div id="voice-transcript"></div>
                <p style="font-size: 0.8rem; color: var(--text); opacity: 0.7; margin-top: 0.5rem;">
                    Hold mic button or press V to speak
                </p>
            </div>
        </aside>
    </main>

    <footer>
        <input type="text" id="input-field" placeholder="Type command or paste Polymarket URL..." autofocus>
        <button class="voice-btn" id="voice-btn">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
            <span>Voice (V)</span>
        </button>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script>
        // Terminal setup
        const term = new Terminal({
            theme: {
                background: '#0d1117',
                foreground: '#c9d1d9',
                cursor: '#58a6ff',
                cursorAccent: '#0d1117',
                selection: '#3fb95040',
                green: '#3fb950',
                red: '#f85149',
                yellow: '#d29922',
                blue: '#58a6ff',
            },
            fontFamily: "'SF Mono', Monaco, 'Courier New', monospace",
            fontSize: 14,
            cursorBlink: true,
            cursorStyle: 'block',
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        window.addEventListener('resize', () => fitAddon.fit());

        // WebSocket connection
        let ws = null;
        const wsStatus = document.getElementById('ws-status');
        const wsStatusText = document.getElementById('ws-status-text');

        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                wsStatus.classList.remove('disconnected');
                wsStatusText.textContent = 'Connected';
                updateStatus();
            };

            ws.onclose = () => {
                wsStatus.classList.add('disconnected');
                wsStatusText.textContent = 'Disconnected';
                setTimeout(connect, 3000);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
            };
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'output':
                    term.writeln(msg.content);
                    break;
                case 'prompt':
                    term.write('\x1b[32m' + msg.content + '\x1b[0m');
                    break;
                case 'echo':
                    term.write('\x1b[32m' + msg.content + '\x1b[0m');
                    break;
                case 'voice':
                    term.writeln('\x1b[33m' + msg.content + '\x1b[0m');
                    break;
                case 'error':
                    term.writeln('\x1b[31m' + msg.content + '\x1b[0m');
                    break;
                case 'clear':
                    term.clear();
                    break;
            }
        }

        function sendCommand(cmd) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'command', content: cmd }));
            }
        }

        function sendVoice(transcript) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'voice', content: transcript }));
            }
        }

        // Input handling
        const inputField = document.getElementById('input-field');

        inputField.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && inputField.value.trim()) {
                sendCommand(inputField.value.trim());
                inputField.value = '';
            }
        });

        // Quick commands
        document.querySelectorAll('.quick-cmd, .api-item').forEach(btn => {
            btn.addEventListener('click', () => {
                const cmd = btn.dataset.cmd;
                if (cmd) {
                    sendCommand(cmd);
                }
            });
        });

        // Voice recognition (Web Speech API)
        const voiceBtn = document.getElementById('voice-btn');
        const voiceTranscript = document.getElementById('voice-transcript');
        let recognition = null;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US'; // Will also recognize Polish

            recognition.onstart = () => {
                voiceBtn.classList.add('recording');
                voiceTranscript.classList.add('active');
                voiceTranscript.textContent = 'Listening...';
            };

            recognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(r => r[0].transcript)
                    .join('');
                voiceTranscript.textContent = transcript;

                if (event.results[0].isFinal) {
                    sendVoice(transcript);
                    setTimeout(() => {
                        voiceTranscript.classList.remove('active');
                    }, 2000);
                }
            };

            recognition.onend = () => {
                voiceBtn.classList.remove('recording');
            };

            recognition.onerror = (event) => {
                console.error('Speech error:', event.error);
                voiceBtn.classList.remove('recording');
                voiceTranscript.textContent = 'Error: ' + event.error;
            };

            // Voice button
            voiceBtn.addEventListener('mousedown', () => {
                recognition.start();
            });

            voiceBtn.addEventListener('mouseup', () => {
                recognition.stop();
            });

            // Keyboard shortcut (V key)
            let vKeyDown = false;
            document.addEventListener('keydown', (e) => {
                if (e.key === 'v' && document.activeElement !== inputField && !vKeyDown) {
                    vKeyDown = true;
                    recognition.start();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.key === 'v' && vKeyDown) {
                    vKeyDown = false;
                    recognition.stop();
                }
            });
        } else {
            voiceBtn.disabled = true;
            voiceBtn.title = 'Voice not supported in this browser';
        }

        // Status updates
        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                document.getElementById('positions-count').textContent = `Positions: ${data.positions || 0}`;
                document.getElementById('usdc-balance').textContent = `USDC: $${(data.usdc || 0).toFixed(2)}`;
            } catch (e) {
                console.error('Status update failed:', e);
            }
        }

        // Update status every 30s
        setInterval(updateStatus, 30000);

        // Connect on load
        connect();
    </script>
</body>
</html>
